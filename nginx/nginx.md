
### 什么是Nginx

nginx是一款高性能的HTTP、反向代理和负载均衡的服务器软件；

### Nginx为什么流行

近几年来,随着硬件成本的降低,个人电脑和移动设备得到了普及,web服务器在互联网中的角色与十几年前的相比已大不相同；

高并发已经成为趋势,而高并发又要求架构具有健壮性和可伸缩性。

这些正是Nginx的特性,它是为性能而生,从发布以来一直侧重于高性能,高并发,低CPU内存消耗;

在功能方面:负载均衡,反向代理,访问控制,热部署,高扩展性等特性又十分适合现代的网络架构；

更可贵的是配置简单文档丰富,大大降低了学习的门槛。这样稳定,性能强,功能丰富又简单的产品当然会受欢迎了。

### Nginx的特点

同是HTTP服务器软件,都采用模块化结构设计
支持通用语言接口,如PHP,Python等
支持正向代理和反向代理
支持虚拟主机及ssl加密传输
支持缓存及压缩传输
支持URL重写
模块多,扩展性强
多平台支持

[正向代理和反向代理](http://bbs.51cto.com/thread-967852-1-1.html)

- 虚拟主机
虚拟主机是指在网络服务器上分出一定的磁盘空间，用户可以租用此部分空间，以供用户放置站点及应用组件，提供必要的数据存放和传输功能。

- URL重写
URL重写就是首先获得一个进入的URL请求然后把它重新写成网站可以处理的另一个URL的过程。举个例子来说，如果通过浏览器进来的URL是“UserProfile.aspx?ID=1”那么它可以被重写成 “UserProfile/1.aspx”，这样的URL，这样的网址可以更好的被网站所阅读。
如果浏览器不支持Cookie或用户阻止了所有Cookie，可以把会话ID附加在HTML页面中所有的URL上，这些页面作为响应发送给客户。这样，当用户单击URL时，会话ID被自动作为请求行的一部分而不是作为头行发送回服务器。这种方法称为URL重写(URL rewriting)

- 热部署
所谓热部署，就是在应用正在运行的时候升级软件，却不需要重新启动应用。

- 负载均衡
负载均衡是一个针对许多节点的分布式负载。在网络行业，它通常作为一个web前端而被用来平衡各个服务器的http流量

Nginx的优势

轻量级 安装文件小 运行时CPU内存使用率低
性能强 支持多核,处理静态文件效率高,内核采用的poll模型最大可以支持50K并发连接
支持热部署 同时启动速度快,可以在不间断服务的情况下对软件和配置进行升级
负载均衡 支持容错和健康检查
代理功能强大 支持无缓存的反向代理,同时支持IMAP/POP3/SMTP的代理
Nginx 的劣势

相比Apache 模块要少一些,常用模块都有了,而且支持LUA语言扩展功能
对动态请求支持不如apache
Windows 版本功能有限 ,受限于windows的特性,支持最好的还是*unix系统

2.6 Nginx工作原理

Nginx由内核和一系列模块组成，内核提供web服务的基本功能,如启用网络协议,创建运行环境,接收和分配客户端请求,处理模块之间的交互。Nginx的各种功能和操作都由模块来实现。Nginx的模块从结构上分为核心模块、基础模块和第三方模块。

核心模块： HTTP模块、EVENT模块和MAIL模块
基础模块： HTTP Access模块、HTTP FastCGI模块、HTTP Proxy模块和HTTP Rewrite模块
第三方模块： HTTP Upstream Request Hash模块、Notice模块和HTTP Access Key模块及用户自己开发的模块
这样的设计使Nginx方便开发和扩展，也正因此才使得Nginx功能如此强大。Nginx的模块默认编译进nginx中，如果需要增加或删除模块，需要重新编译Nginx,这一点不如Apache的动态加载模块方便。如果有需要动态加载模块，可以使用由淘宝网发起的web服务器Tengine，在nginx的基础上增加了很多高级特性，完全兼容Nginx，已被国内很多网站采用。

 Nginx的常用架构简介

 web历史上最流行最经典的环境是LAMP（Linux + Apache + Mysql + PHP）,至今仍有大量网站采用此架构，Apache默认配置在未优化的情况下比较占用CPU和内存。借助于Nginx的轻量和高性能，LNMP架构只是将LAMP环境中的Apache换成Nginx，于是另一经典LNMP架构就诞生了。LNMP在服务器硬件配置相同时，想对于LAMP会使用更少的CPU和内存，是小型网站，低配服务器，和VPS的福音。LNMP架构后续会有实战，大家后续会详细了解到。

- LNMP架构

- LNAMP架构

当web应用发展到一定程度时，单台服务器不足以支撑业务的正常运行，为增大吞吐量往往会使用多台服务器一起提供服务，如何充分利用多台服务器的资源，就需要一个’调度员‘，这个调度员要求能高效的接收并分发请求，知道后端的服务器健康状态，要能方便的扩展和移除，这就是Nginx又一常见应用架构，此架构充分利用了Nginx的反向代理和负载均衡的优势，Nginx本身不提供web服务，而是在前端接受web请求并分发到后端服务器处理，后端服务器可以是Apache，tomcat，IIS等。

- Web调度员Nginx
 ![负载均衡和反响代理](https://dn-anything-about-doc.qbox.me/nginx/nginxloadbancer.png)

- 什么是LNMP？

网站服务器架构中的系统环境

![](https://dn-anything-about-doc.qbox.me/userid19824labid404time1421828735183)

#### N的作用
在 LNMP 中的作用或角色：Nginx 是一个高性能的 HTTP 和反向代理服务器，也是一个 IMAP/POP3/SMTP 代理服务器。

#### M的作用

在 LNMP 中的作用或角色：Mysql 是一个小型关系型数据库管理系统 mysql 的安装分为服务端与客户端 服务端安装

#### P(php5 安装)

在 LNMP 中的作用或角色：nginx 本身不能处理 PHP，它只是个 web 服务器，当接收到请求后，如果是 php 请求，则发给 php 解释器处理，并把结果返回给客户端.php-fpm 是一个守护进程（FastCGI 进程管理器）用于替换 PHP FastCGI 的大部分附加功能，对于高负载网站是非常有用的。

CGI就是一套接口规则，它用于HTTP服务器和动态处理程序之间的通讯方式的确立。FastCGI可以算是CGI的一种实现，它通过让CGI处理程序常驻进程，让一个CGI进程可以处理多个请求，减少了反复启动CGI程序的时间和资源的消耗。

##### php-fpm fastcgi phpcgi这些是干嘛用的?

php-cgi就是一个用来提供PHP程序处理的FastCGI。
php-fpm（FastCGI Process Manager）则是在FastCGI程序之上来管理FastCGI进程的管理工具。
php-cgi是单进程的，开启一个php-cgi来处理请求时，一次只能处理一个请求，其余请求时排队的。
php-fpm则管理多个FastCGI进程，让请求可以并行发送到多个FastCGI进程同时处理。
可以简单的理解为php-fpm管理着多个php-cgi

举个简单的例子，一个请求从客户端发送到Nginx服务器再由PHP程序处理的过程：

请求发送到Nginx服务器，Nginx服务器根据配置将其发送到php-fpm，然而Nginx和php-fpm是两家公司的产品，他们如果确保相互之间能读懂对方发送的信息内容的？这就是因为他们在设计时都遵循了CGI的规则。
php-fpm收到请求后，会在自己所管理的FastCGI进程中找到一个空闲的进程，来处理这个请求
另外Nginx也可以对接php-cgi，不过php-cgi没有进程管理模块，而就是单进程的;


---

 nginx架构
nginx进程
nginx模块

 Nginx 架构介绍

 Nginx 的代码是由一个核心和一系列的模块组成。

核心主要用于提供 WebServer 的基本功能，以及 Web 和 Mail 反向代理的功能；还用于启用网络协议，创建必要的运行时环境以及确保不同的模块之间平滑地进行交互。不过，大多跟协议相关的功能和应用特有的功能都是由 nginx 的模块实现的。

这些功能模块大致可以分为事件模块、阶段性处理器、输出过滤器、变量处理器、协议、upstream 和负载均衡几个类别，这些共同组成了 nginx 的 http 功能。

- 事件模块

事件模块主要用于提供 OS 独立的(不同操作系统的事件机制有所不同)事件通知机制如 kqueue 或 epoll 等。

- 协议模块

协议模块则负责实现 nginx 通过 http、tls/ssl、smtp、pop3 以及 imap 与对应的客户端建立会话

在 Nginx 内部，进程间的通信是通过模块的 pipeline 或 chain 实现的；换句话说，每一个功能或操作都由一个模块来实现。

Nginx 进程介绍

nginx 是以多进程的方式来工作的，当然 nginx 也是支持多线程的方式的。nginx 启动后，在 unix 系统中会以 daemon 的方式在后台运行，后台进程包含一个 master 进程和多个 worker 进程（你可以理解为工人和管理员）。这里就主要讲解 nginx 的多进程模式。

套接字

源IP地址和目的IP地址以及源端口号和目的端口号的组合称为套接字。其用于标识客户端请求的服务器和服务。
它是网络通信过程中端点的抽象表示，包含进行网络通信必需的五种信息：连接使用的协议，本地主机的IP地址，本地进程的协议端口，远地主机的IP地址，远地进程的协议端口。

![](https://imgsa.baidu.com/baike/crop%3D0%2C2%2C500%2C330%3Bc0%3Dbaike80%2C5%2C5%2C80%2C26/sign=7664b1ddfbdeb48fef26fb9ecd2f161b/b03533fa828ba61e234de3934934970a314e59ee.jpg)

nginx 不会为每个连接派生进程或线程，而是由 worker 进程通过监听共享套接字接受新请求，并且使用高效的循环来处理数千个连接。Nginx 不使用仲裁器或分发器来分发连接，这个工作由操作系统内核机制完成。监听套接字在启动时就完成初始化，worker 进程通过这些套接字接受、读取请求和输出响应。

master与worker

master：

当 nginx 在启动后，会有一个 master 进程和多个 worker 进程。master进程主要用来管理worker进程，master 要做的就是：接收来自外界的信号，向各 worker 进程发送信号，监控 worker 进程的运行状态，当 worker 进程退出后(异常情况下)，会自动重新启动新的 worker 进程。

主要完成如下工作：

读取并验证配置信息；
创建、绑定及关闭套接字；
启动、终止 worker 进程及维护 worker 进程的个数；
无须中止服务而重新配置工作；
控制非中断式程序升级，启用新的二进制程序并在需要时回滚至老版本；
重新打开日志文件；
编译嵌入式 perl 脚本
worker：

对于基本的网络事件，则是放在 worker 进程中来处理了。多个 worker 进程之间是对等的，他们同等竞争来自客户端的请求，各进程互相之间是独立的。一个请求，只可能在一个 worker 进程中处理，一个 worker 进程，不可能处理其它进程的请求（一对一）。然而 nginx 没有专门地仲裁或连接分布的 worker,这项工作是由操作系统内核机制完成的。在启动时,创建一组初始的监听套接字，HTTP 请求和响应之时，worker 连续接收、读取和写入套接字。

worker 进程主要完成的任务包括

接收、传入并处理来自客户端的连接；
提供反向代理及过滤功能；
nginx 任何能完成的其它任务

- Memcached
Memcached 是一个高性能的分布式内存对象缓存系统，用于动态Web应用以减轻数据库负载。它通过在内存中缓存数据和对象来减少读取数据库的次数，从而提高动态、数据库驱动网站的速度

![](https://dn-anything-about-doc.qbox.me/md0417411architecture.png)

既然 worker 进程之间是平等的，每个进程，处理请求的机会也是一样的。当我们提供 80 端口的 http 服务时，一个连接请求过来，每个进程都有可能处理这个连接。那么问题来了，到底最后怎样处理，是由什么决定的呢？首先，每个 worker 进程都是从 master 进程 fork 过来，在 master 进程里面，先建立好需要 listen 的 socket（listenfd）之后，然后再 fork 出多个 worker 进程。所有 worker 进程的 listenfd 会在新连接到来时变得可读，为保证只有一个进程处理该连接，所有 worker 进程会在注册 listenfd 读事件前抢 accept_mutex，抢到互斥锁的那个进程注册 listenfd 读事件，然后在读事件里调用 accept 接受该连接。当一个 worker 进程在 accept 这个连接之后，就开始读取请求、解析请求、处理请求。产生数据后，再返回给客户端，最后才断开连接，这样一个完整的请求就是这样的了。我们可以看到：一个请求，完全由 worker 进程来处理，而且只在一个 worker 进程中处理。

也许你还有个疑问，那就是 nginx 采用多 worker 的方式来处理请求，每个 worker 里面只有一个主线程，那能够处理的并发数很有限啊，多少个 worker 就能处理多少个并发，何来高并发呢？然而，这就是 nginx 的高明之处，nginx 采用了异步非阻塞的方式来处理请求，也就是说，nginx 是可以同时处理成千上万个请求的。

异步非阻塞

异步的概念是和同步相对的，也就是不同事件之间不是同时发生的。非阻塞的概念是和阻塞对应的，阻塞是事件按顺序执行，每一事件都要等待上一事件的完成，而非阻塞是如果事件没有准备好，这个事件可以直接返回，过一段时间再进行处理询问，这期间可以做其他事情。

基本就是：在特定地方调用函数。（Nginx 本身支持多种模块，如 HTTP 模块、EVENTS 模块和 MAIL 模块，这里只简单讲述 HTTP 的模块及其中的命令） 下面是配置文件结构图：

![](https://dn-anything-about-doc.qbox.me/userid20406labid411time1422495978452)

Nginx 本身做的工作实际很少，当它接到一个 HTTP 请求时，它仅仅是通过查找配置文件将此次请求映射到一个 locationblock，而此 location 中所配置的各个指令则会启动不同的模块去完成工作，因此模块可以看做 Nginx 真正的劳动工作者。通常一个 location 中的指令会涉及一个 handler 模块和多个 filter 模块（当然，多个 location 可以复用同一个模块）。handler 模块负责处理请求，完成响应内容的生成，而 filter 模块对响应内容进行处理。因此 Nginx 模块开发分为 handler 开发和 filter 开发（本文不考虑 load-balancer 模块）。下图展示了一次常规请求和响应的过程。

![](https://dn-anything-about-doc.qbox.me/userid20406labid411time1422497618598)

apache 轮询

nginx epoll事件监听

cgi保证webserver传递过来的数据是标准格式

用户访问index.php，nginx知道这不是静态文件需要执行php解释器，首先会将请求进行简单处理（cgi协议）发送给php解释器具体标准格式的参数；

cgi在处理请求的时候会fork一个子进程，处理完后释放；

fastcgi是程序启动一个进程，这个进程有n个子进程，将子进程放入内存

php-fpm就是php的解释器

$ ps aux | grep php-fpm
$ sudo kill -USR2 2760